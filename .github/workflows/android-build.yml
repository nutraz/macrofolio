name: Android CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout @v3
      with:
        submodules: recursive
    
    - name: Setup Java 17
      uses: actions/setup-java @v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Node.js
      uses: actions/setup-node @v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'src/macrofolio_assets/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./src/macrofolio_assets
      run: |
        npm ci --legacy-peer-deps
        npm install -g @capacitor/cli
    
    - name: Build web assets
      working-directory: ./src/macrofolio_assets
      run: npm run build
    
    - name: Setup Android SDK
      uses: android-actions/setup-android @v2
    
    - name: Add Android platform
      working-directory: ./src/macrofolio_assets
      run: |
        npx cap add android
        npx cap sync android
    
    - name: Build Android Debug APK
      working-directory: ./src/macrofolio_assets/android
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug --stacktrace
    
    - name: Upload APK artifact
      uses: actions/upload-artifact @v3
      with:
        name: macrofolio-android-apk
        path: src/macrofolio_assets/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7
    
    - name: Build Android Release APK
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      working-directory: ./src/macrofolio_assets/android
      run: |
        # Create a simple keystore for signing (for testing only)
        keytool -genkeypair \
          -alias macrofolio \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storetype PKCS12 \
          -keystore macrofolio.keystore \
          -storepass "macrofolio123" \
          -keypass "macrofolio123" \
          -dname "CN=Macrofolio, OU=Development, O=Macrofolio, L=SanFrancisco, S=California, C=US" \
          -noprompt
        
        ./gradlew assembleRelease
        
    - name: Upload Release APK
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: actions/upload-artifact @v3
      with:
        name: macrofolio-android-release
        path: src/macrofolio_assets/android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 7
EOF
